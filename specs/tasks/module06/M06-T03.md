# M06-T03: Define PersistentMemoryStore Interface

```yaml
metadata:
  id: "M06-T03"
  title: "Define PersistentMemoryStore Interface"
  module: "module-06"
  module_name: "Stub Elimination"
  layer: "foundation"
  priority: "critical"
  estimated_hours: 3
  created: "2026-01-04"
  status: "ready"
  dependencies: []
  spec_refs:
    - "constitution.yaml:30"         # db: prod postgres, dev sqlite
    - "contextprd.md:106-111"        # KnowledgeNode schema
```

## Problem Statement

The `InMemoryStore` stub returns hardcoded 0.5 similarity for ALL search queries, making retrieval meaningless. We need a proper interface for persistent storage.

### Current State (BROKEN)

```rust
// stubs/memory_store_stub.rs
impl MemoryStore for InMemoryStore {
    async fn search(&self, query_embedding: &[f32], top_k: usize) -> CoreResult<Vec<SearchResult>> {
        // Returns ALL nodes with 0.5 similarity - MEANINGLESS
        let results = self.nodes.iter()
            .take(top_k)
            .map(|(id, node)| SearchResult {
                node: node.clone(),
                similarity: 0.5, // FAKE - always 0.5
            })
            .collect();
        Ok(results)
    }
}
```

## Context

The `MemoryStore` trait already exists but the only implementation is an in-memory stub. We need to define additional interfaces for persistent storage backends.

## Input Context Files

```
crates/context-graph-core/src/traits/memory_store.rs    # Existing trait
crates/context-graph-core/src/stubs/memory_store_stub.rs # Stub to study
crates/context-graph-core/src/graph/memory_node.rs       # Node schema
```

## Prerequisites

- [ ] `MemoryStore` trait exists
- [ ] `MemoryNode` and `SearchResult` types defined

## Scope

### In Scope

- Review existing `MemoryStore` trait for completeness
- Add missing methods for persistence (save, load, compact)
- Define `StorageConfig` for backend selection
- Ensure trait supports both SQLite and RocksDB backends
- Fix `InMemoryStore` to compute real cosine similarity

### Out of Scope

- Implementing RocksDB backend (M06-T05)
- Implementing PostgreSQL backend (future)
- Vector indexing (handled by GraphIndex trait)

## Definition of Done

### Signatures

```rust
// File: crates/context-graph-core/src/traits/memory_store.rs (ENHANCED)
use async_trait::async_trait;
use crate::error::CoreResult;
use crate::graph::MemoryNode;

/// Search result with similarity score
#[derive(Debug, Clone)]
pub struct SearchResult {
    pub node: MemoryNode,
    pub similarity: f32, // MUST be computed, not hardcoded
}

/// Configuration for storage backend
#[derive(Debug, Clone)]
pub struct StorageConfig {
    pub backend: StorageBackend,
    pub path: Option<PathBuf>,
    pub cache_size_mb: usize,
    pub sync_writes: bool,
}

#[derive(Debug, Clone)]
pub enum StorageBackend {
    InMemory,
    SQLite,
    RocksDB,
    PostgreSQL,
}

/// Trait for memory storage operations
#[async_trait]
pub trait MemoryStore: Send + Sync {
    // Existing methods
    async fn store(&self, node: MemoryNode) -> CoreResult<()>;
    async fn get(&self, id: &Uuid) -> CoreResult<Option<MemoryNode>>;
    async fn search(&self, query_embedding: &[f32], top_k: usize) -> CoreResult<Vec<SearchResult>>;
    async fn delete(&self, id: &Uuid) -> CoreResult<bool>;
    async fn update(&self, node: MemoryNode) -> CoreResult<()>;
    async fn list_all(&self) -> CoreResult<Vec<MemoryNode>>;

    // NEW: Persistence methods
    async fn flush(&self) -> CoreResult<()>;
    async fn compact(&self) -> CoreResult<()>;
    async fn checkpoint(&self) -> CoreResult<PathBuf>;
    async fn restore(&self, checkpoint: &Path) -> CoreResult<()>;

    // NEW: Stats
    fn node_count(&self) -> usize;
    fn storage_size_bytes(&self) -> usize;
    fn backend_type(&self) -> StorageBackend;
}
```

### Constraints

- `search()` MUST compute real cosine similarity
- Search results MUST be sorted by similarity (descending)
- `top_k` MUST be respected
- All async methods MUST NOT block the runtime
- MUST handle concurrent access safely

### Verification

```bash
# 1. Trait enhanced
grep -n "async fn flush" crates/context-graph-core/src/traits/memory_store.rs

# 2. InMemoryStore fixed
cargo test -p context-graph-core test_inmemory_search_computes_real_similarity

# 3. Search returns sorted results
cargo test -p context-graph-core test_search_results_sorted_by_similarity
```

## Pseudo Code

```
MemoryStore Trait Enhancement:

  # Add to existing trait:
  async fn flush(&self) -> Result<()>         # Write buffered data
  async fn compact(&self) -> Result<()>        # Optimize storage
  async fn checkpoint(&self) -> Result<Path>   # Create recoverable snapshot
  async fn restore(&self, path) -> Result<()>  # Restore from snapshot
  fn node_count(&self) -> usize
  fn storage_size_bytes(&self) -> usize
  fn backend_type(&self) -> StorageBackend

Fix InMemoryStore.search():

  async fn search(query_embedding, top_k):
    results = []
    for (id, node) in self.nodes:
      # Compute REAL cosine similarity
      similarity = cosine_similarity(query_embedding, node.embedding)
      results.push(SearchResult { node, similarity })

    # Sort by similarity descending
    results.sort_by(|a, b| b.similarity.partial_cmp(&a.similarity))

    # Take top_k
    return results.into_iter().take(top_k).collect()

  fn cosine_similarity(a, b):
    dot = sum(a[i] * b[i] for i in 0..len(a))
    mag_a = sqrt(sum(x*x for x in a))
    mag_b = sqrt(sum(x*x for x in b))
    if mag_a == 0 || mag_b == 0:
      return 0.0
    return dot / (mag_a * mag_b)
```

## Files to Modify

| File | Change |
|------|--------|
| `crates/context-graph-core/src/traits/memory_store.rs` | Add new methods to trait |
| `crates/context-graph-core/src/stubs/memory_store_stub.rs` | Fix search to compute real similarity |

## Files to Create

| File | Description |
|------|-------------|
| `crates/context-graph-core/src/storage/mod.rs` | Storage configuration types |

## Validation Criteria

- [ ] Trait has all persistence methods
- [ ] `InMemoryStore.search()` computes real cosine similarity
- [ ] Search results sorted by similarity (descending)
- [ ] Different embeddings produce different similarities
- [ ] Identical embedding produces similarity = 1.0
- [ ] Orthogonal embeddings produce similarity = 0.0

## Test Commands

```bash
# Run all storage tests
cargo test -p context-graph-core memory_store

# Verify similarity computation
cargo test -p context-graph-core test_cosine_similarity_computation

# Verify sorting
cargo test -p context-graph-core test_search_returns_sorted
```

---

*Task created: 2026-01-04*
*Module: 06 - Stub Elimination*
*Layer: Foundation*
*Priority: CRITICAL*
