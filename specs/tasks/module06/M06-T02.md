# M06-T02: Define EmbeddingProvider Trait & Factory

```yaml
metadata:
  id: "M06-T02"
  title: "Define EmbeddingProvider Trait & Factory"
  module: "module-06"
  module_name: "Stub Elimination"
  layer: "foundation"
  priority: "critical"
  estimated_hours: 4
  created: "2026-01-04"
  status: "ready"
  dependencies: []
  spec_refs:
    - "constitution.yaml:305-323"   # 12-model embedding pipeline
    - "contextprd.md:83-101"        # Embedding models
```

## Problem Statement

The MCP handlers use fake embeddings `vec![0.1; 1536]` instead of real embedding generation. The `context-graph-embeddings` crate has real models but no injectable trait for the MCP layer.

### Current State (BROKEN)

```rust
// handlers/tools.rs:230 - FAKE embedding
let embedding = vec![0.1; 1536]; // All nodes get identical meaningless vectors

// handlers/memory.rs:42 - FAKE embedding
let embedding = vec![0.1; 1536]; // Search is meaningless
```

### Desired State

```rust
// Inject real embedding provider
let embedding = self.embedding_provider.embed(content).await?;
```

## Context

The embedding crate has real Candle-based models but they're not exposed via a trait that can be injected into handlers. We need:
1. A trait defining the embedding interface
2. A factory to create real or stub providers
3. Feature-gated implementations

## Input Context Files

```
crates/context-graph-embeddings/src/lib.rs          # Current API
crates/context-graph-embeddings/src/models/         # Candle implementations
crates/context-graph-mcp/src/handlers/tools.rs      # Consumer code
```

## Prerequisites

- [ ] `context-graph-embeddings` crate compiles with candle feature
- [ ] Candle models exist in `models/` directory

## Scope

### In Scope

- Define `EmbeddingProvider` trait in `context-graph-core`
- Define `EmbeddingResult` with dimension info
- Create `EmbeddingProviderFactory` for runtime selection
- Create stub implementation for testing
- Document feature flags for real vs stub

### Out of Scope

- Implementing real Candle provider (M06-T04)
- Wiring into MCP handlers (M06-T10)
- Multi-model fusion (future module)

## Definition of Done

### Signatures

```rust
// File: crates/context-graph-core/src/traits/embedding_provider.rs
use async_trait::async_trait;
use crate::error::CoreResult;

/// Result of embedding generation
#[derive(Debug, Clone)]
pub struct EmbeddingResult {
    pub vector: Vec<f32>,
    pub model_id: String,
    pub dimensions: usize,
    pub latency_ms: f64,
}

/// Trait for embedding generation
#[async_trait]
pub trait EmbeddingProvider: Send + Sync {
    /// Generate embedding for text content
    async fn embed(&self, content: &str) -> CoreResult<EmbeddingResult>;

    /// Generate embeddings for batch of texts
    async fn embed_batch(&self, contents: &[String]) -> CoreResult<Vec<EmbeddingResult>>;

    /// Get embedding dimensions
    fn dimensions(&self) -> usize;

    /// Get model identifier
    fn model_id(&self) -> &str;

    /// Check if provider is ready
    fn is_ready(&self) -> bool;
}

// File: crates/context-graph-core/src/stubs/embedding_stub.rs
/// Stub implementation for testing (NOT for production)
pub struct StubEmbeddingProvider {
    dimensions: usize,
    model_id: String,
}

impl StubEmbeddingProvider {
    pub fn new() -> Self;
    pub fn with_dimensions(dimensions: usize) -> Self;
}

#[async_trait]
impl EmbeddingProvider for StubEmbeddingProvider {
    // Returns deterministic embeddings based on content hash
    async fn embed(&self, content: &str) -> CoreResult<EmbeddingResult>;
    async fn embed_batch(&self, contents: &[String]) -> CoreResult<Vec<EmbeddingResult>>;
    fn dimensions(&self) -> usize;
    fn model_id(&self) -> &str;
    fn is_ready(&self) -> bool;
}
```

### Constraints

- Trait MUST be async for GPU/API operations
- Stub MUST use content hash, NOT hardcoded `vec![0.1; 1536]`
- Batch operations MUST be efficient (single model call)
- Dimensions MUST be configurable (default 1536)
- MUST implement Send + Sync for concurrent use

### Verification

```bash
# 1. Compile check
cargo build -p context-graph-core

# 2. Trait exists
grep -n "pub trait EmbeddingProvider" crates/context-graph-core/src/traits/embedding_provider.rs

# 3. Unit tests
cargo test -p context-graph-core embedding_provider

# 4. Stub produces different vectors for different content
cargo test -p context-graph-core test_stub_embedding_not_constant
```

## Pseudo Code

```
EmbeddingProvider Trait (crates/context-graph-core/src/traits/embedding_provider.rs):

  trait EmbeddingProvider:
    async embed(content: str) -> EmbeddingResult
    async embed_batch(contents: [str]) -> [EmbeddingResult]
    fn dimensions() -> usize
    fn model_id() -> str
    fn is_ready() -> bool

StubEmbeddingProvider (crates/context-graph-core/src/stubs/embedding_stub.rs):

  struct StubEmbeddingProvider:
    dimensions: usize = 1536
    model_id: String = "stub-embedding-v1"

  async embed(content):
    # Generate deterministic but content-aware embedding
    hash = xxhash64(content)
    seed = hash as u64
    rng = StdRng::seed_from_u64(seed)
    vector = (0..dimensions).map(|_| rng.gen_range(-1.0..1.0)).collect()
    # Normalize to unit length
    norm = sqrt(sum(v*v for v in vector))
    vector = vector.map(|v| v / norm)

    return EmbeddingResult {
      vector,
      model_id: self.model_id.clone(),
      dimensions: self.dimensions,
      latency_ms: 0.1,
    }

  async embed_batch(contents):
    # Process in parallel
    futures::join_all(contents.iter().map(|c| self.embed(c))).await
```

## Files to Create

| File | Description |
|------|-------------|
| `crates/context-graph-core/src/traits/embedding_provider.rs` | Trait definition |
| `crates/context-graph-core/src/stubs/embedding_stub.rs` | Stub implementation |

## Files to Modify

| File | Change |
|------|--------|
| `crates/context-graph-core/src/traits/mod.rs` | Add `pub mod embedding_provider;` |
| `crates/context-graph-core/src/stubs/mod.rs` | Add `pub mod embedding_stub;` |
| `crates/context-graph-core/src/lib.rs` | Re-export new types |

## Validation Criteria

- [ ] Trait compiles and is accessible from MCP crate
- [ ] Stub generates unique embeddings per content
- [ ] Stub embeddings are normalized (magnitude ~1.0)
- [ ] Batch embedding works correctly
- [ ] `is_ready()` returns appropriate values
- [ ] Thread safety verified (can be shared across handlers)

## Test Commands

```bash
# Run unit tests
cargo test -p context-graph-core embedding

# Verify stub uniqueness
cargo test -p context-graph-core test_stub_different_content_different_embedding

# Verify normalization
cargo test -p context-graph-core test_stub_embedding_normalized
```

---

*Task created: 2026-01-04*
*Module: 06 - Stub Elimination*
*Layer: Foundation*
*Priority: CRITICAL*
