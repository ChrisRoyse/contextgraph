# TASK-M02-021: Complete CognitivePulse Struct (7 Fields)

## Task Metadata
| Field | Value |
|-------|-------|
| Task ID | TASK-M02-021 |
| Status | **READY** |
| Layer | surface |
| Module | module-02 |
| Priority | critical |
| Estimated Hours | 2 |
| Depends On | TASK-M02-019 ✅, TASK-M02-020 ✅ |
| Implements | REQ-CORE-007, TECH-CORE-002 Section 2.4, constitution.yaml pulse spec |

---

## Critical Context for AI Agent

**READ THIS FIRST**: You are implementing a cognitive state struct for a bio-nervous knowledge graph system. The CognitivePulse is returned with EVERY MCP tool response (~30 tokens) to guide agent behavior.

### Project Structure (VERIFIED 2025-12-31)
```
/home/cabdru/contextgraph/
├── crates/
│   └── context-graph-core/
│       ├── Cargo.toml           # chrono dependency EXISTS
│       └── src/
│           └── types/
│               ├── mod.rs       # Re-exports: pub use pulse::*
│               ├── pulse.rs     # TARGET FILE - CognitivePulse + SuggestedAction
│               └── utl.rs       # EmotionalState enum (7 variants) ✅
└── docs2/
    └── constitution.yaml        # Source of truth for pulse spec
```

### Dependencies Status (VERIFIED)
- **TASK-M02-019**: ✅ COMPLETE - `EmotionalState` in `types/utl.rs` (7 variants, weight_modifier(), description())
- **TASK-M02-020**: ✅ COMPLETE - `SuggestedAction` in `types/pulse.rs` (7 variants, Default=Continue, description())
- **chrono**: ✅ EXISTS in `Cargo.toml` line 18

---

## Current State vs Required State

### WHAT EXISTS NOW (pulse.rs lines 22-34)
```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub struct CognitivePulse {
    pub entropy: f32,           // ✅ EXISTS
    pub coherence: f32,         // ✅ EXISTS
    pub suggested_action: SuggestedAction,  // ✅ EXISTS
}
```
**Current field count: 3**

### WHAT IS REQUIRED (per constitution.yaml and task spec)
```rust
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct CognitivePulse {
    pub entropy: f32,                        // [0,1] uncertainty/novelty
    pub coherence: f32,                      // [0,1] structural consistency
    pub curiosity_score: f32,                // [0,1] exploration drive ⚠️ MISSING
    pub confidence: f32,                     // [0,1] context quality certainty ⚠️ MISSING
    pub emotional_state: EmotionalState,     // UTL emotional weight ⚠️ MISSING
    pub suggested_action: SuggestedAction,   // Recommended action
    pub timestamp: DateTime<Utc>,            // Snapshot time ⚠️ MISSING
}
```
**Required field count: 7**

### MISSING ITEMS
| Item | Type | Why Needed |
|------|------|------------|
| `curiosity_score` | f32 | Exploration drive metric [0,1] |
| `confidence` | f32 | Context quality certainty [0,1] |
| `emotional_state` | EmotionalState | UTL wₑ weight source |
| `timestamp` | DateTime<Utc> | Pulse snapshot timing |

---

## Exact Implementation Required

### Step 1: Add Import (pulse.rs top)
```rust
use chrono::{DateTime, Utc};
use super::utl::EmotionalState;  // Import from sibling module
```

### Step 2: Replace CognitivePulse Struct (pulse.rs lines 22-34)

**DELETE this block:**
```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub struct CognitivePulse {
    pub entropy: f32,
    pub coherence: f32,
    pub suggested_action: SuggestedAction,
}
```

**REPLACE with:**
```rust
/// Represents the current cognitive state of the system.
///
/// The pulse is returned with every context injection (~30 tokens)
/// and guides agent behavior based on entropy/coherence levels.
///
/// # Metrics
/// - `entropy`: [0,1] - Measure of uncertainty/novelty in current context
/// - `coherence`: [0,1] - Measure of structural consistency
/// - `curiosity_score`: [0,1] - Drive to explore new information
/// - `confidence`: [0,1] - Certainty in current context quality
///
/// # Example Response
/// ```json
/// {"entropy": 0.3, "coherence": 0.8, "curiosity_score": 0.5,
///  "confidence": 0.7, "emotional_state": "focused",
///  "suggested_action": "ready", "timestamp": "2025-01-01T00:00:00Z"}
/// ```
#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]
pub struct CognitivePulse {
    /// Entropy/novelty measure [0,1]. Higher = more uncertainty.
    pub entropy: f32,

    /// Coherence/consistency measure [0,1]. Higher = more structured.
    pub coherence: f32,

    /// Curiosity/exploration drive [0,1]. Higher = more exploratory.
    pub curiosity_score: f32,

    /// Confidence in context quality [0,1]. Higher = more certain.
    pub confidence: f32,

    /// Current emotional state affecting UTL calculations.
    pub emotional_state: EmotionalState,

    /// Recommended action based on current metrics.
    pub suggested_action: SuggestedAction,

    /// Timestamp of this pulse snapshot.
    pub timestamp: DateTime<Utc>,
}
```

### Step 3: Update Default Implementation (pulse.rs lines 36-44)

**DELETE:**
```rust
impl Default for CognitivePulse {
    fn default() -> Self {
        Self {
            entropy: 0.5,
            coherence: 0.5,
            suggested_action: SuggestedAction::Continue,
        }
    }
}
```

**REPLACE with:**
```rust
impl Default for CognitivePulse {
    fn default() -> Self {
        Self {
            entropy: 0.5,
            coherence: 0.5,
            curiosity_score: 0.5,
            confidence: 0.5,
            emotional_state: EmotionalState::default(), // Neutral
            suggested_action: SuggestedAction::Continue,
            timestamp: Utc::now(),
        }
    }
}
```

### Step 4: Update `new()` Method (pulse.rs lines 51-60)

**DELETE:**
```rust
pub fn new(entropy: f32, coherence: f32, suggested_action: SuggestedAction) -> Self {
    let entropy = entropy.clamp(0.0, 1.0);
    let coherence = coherence.clamp(0.0, 1.0);

    Self {
        entropy,
        coherence,
        suggested_action,
    }
}
```

**REPLACE with:**
```rust
/// Create a new pulse with explicit values.
///
/// All f32 metrics are clamped to [0,1] range.
/// For auto-computed action, use `CognitivePulse::computed()` instead.
pub fn new(
    entropy: f32,
    coherence: f32,
    curiosity_score: f32,
    confidence: f32,
    emotional_state: EmotionalState,
    suggested_action: SuggestedAction,
) -> Self {
    Self {
        entropy: entropy.clamp(0.0, 1.0),
        coherence: coherence.clamp(0.0, 1.0),
        curiosity_score: curiosity_score.clamp(0.0, 1.0),
        confidence: confidence.clamp(0.0, 1.0),
        emotional_state,
        suggested_action,
        timestamp: Utc::now(),
    }
}
```

### Step 5: Update `computed()` Method (pulse.rs lines 64-74)

**DELETE:**
```rust
pub fn computed(entropy: f32, coherence: f32) -> Self {
    let entropy = entropy.clamp(0.0, 1.0);
    let coherence = coherence.clamp(0.0, 1.0);
    let suggested_action = Self::compute_action(entropy, coherence);

    Self {
        entropy,
        coherence,
        suggested_action,
    }
}
```

**REPLACE with:**
```rust
/// Create a new pulse with auto-computed suggested action.
///
/// Curiosity and confidence default to 0.5, emotional_state to Neutral.
pub fn computed(entropy: f32, coherence: f32) -> Self {
    let entropy = entropy.clamp(0.0, 1.0);
    let coherence = coherence.clamp(0.0, 1.0);
    let suggested_action = Self::compute_action(entropy, coherence);

    Self {
        entropy,
        coherence,
        curiosity_score: 0.5,
        confidence: 0.5,
        emotional_state: EmotionalState::default(),
        suggested_action,
        timestamp: Utc::now(),
    }
}
```

### Step 6: Add New Tests (bottom of pulse.rs test module)

Add these tests to the existing `#[cfg(test)] mod tests`:

```rust
// =======================================================================
// CognitivePulse 7-Field Tests (TASK-M02-021)
// =======================================================================

#[test]
fn test_cognitive_pulse_has_7_fields() {
    let pulse = CognitivePulse::default();
    // Access all 7 fields to prove they exist
    let _ = pulse.entropy;
    let _ = pulse.coherence;
    let _ = pulse.curiosity_score;
    let _ = pulse.confidence;
    let _ = pulse.emotional_state;
    let _ = pulse.suggested_action;
    let _ = pulse.timestamp;
}

#[test]
fn test_cognitive_pulse_default_values() {
    let pulse = CognitivePulse::default();
    assert_eq!(pulse.entropy, 0.5);
    assert_eq!(pulse.coherence, 0.5);
    assert_eq!(pulse.curiosity_score, 0.5);
    assert_eq!(pulse.confidence, 0.5);
    assert_eq!(pulse.emotional_state, EmotionalState::default());
    assert_eq!(pulse.suggested_action, SuggestedAction::Continue);
    // timestamp should be recent (within last second)
    let now = Utc::now();
    assert!(pulse.timestamp <= now);
    assert!(pulse.timestamp > now - chrono::Duration::seconds(1));
}

#[test]
fn test_cognitive_pulse_serde_roundtrip_all_fields() {
    use super::super::utl::EmotionalState;

    let pulse = CognitivePulse::new(
        0.3, 0.8, 0.6, 0.9,
        EmotionalState::Focused,
        SuggestedAction::Ready,
    );

    let json = serde_json::to_string(&pulse).unwrap();
    let parsed: CognitivePulse = serde_json::from_str(&json).unwrap();

    assert_eq!(pulse.entropy, parsed.entropy);
    assert_eq!(pulse.coherence, parsed.coherence);
    assert_eq!(pulse.curiosity_score, parsed.curiosity_score);
    assert_eq!(pulse.confidence, parsed.confidence);
    assert_eq!(pulse.emotional_state, parsed.emotional_state);
    assert_eq!(pulse.suggested_action, parsed.suggested_action);
    assert_eq!(pulse.timestamp, parsed.timestamp);
}

#[test]
fn test_cognitive_pulse_json_format() {
    let pulse = CognitivePulse::new(
        0.3, 0.8, 0.5, 0.7,
        EmotionalState::Focused,
        SuggestedAction::Ready,
    );

    let json = serde_json::to_string(&pulse).unwrap();

    // Verify all expected fields are in JSON
    assert!(json.contains("\"entropy\""));
    assert!(json.contains("\"coherence\""));
    assert!(json.contains("\"curiosity_score\""));
    assert!(json.contains("\"confidence\""));
    assert!(json.contains("\"emotional_state\""));
    assert!(json.contains("\"suggested_action\""));
    assert!(json.contains("\"timestamp\""));
}

#[test]
fn test_cognitive_pulse_clamps_all_metrics() {
    let pulse = CognitivePulse::new(
        1.5, -0.5, 2.0, -1.0,
        EmotionalState::Neutral,
        SuggestedAction::Continue,
    );

    assert_eq!(pulse.entropy, 1.0);
    assert_eq!(pulse.coherence, 0.0);
    assert_eq!(pulse.curiosity_score, 1.0);
    assert_eq!(pulse.confidence, 0.0);
}

#[test]
fn test_cognitive_pulse_timestamp_is_utc() {
    let pulse = CognitivePulse::default();
    // Verify timestamp is in UTC (chrono::Utc type enforces this)
    let json = serde_json::to_string(&pulse).unwrap();
    // UTC timestamps end with Z or +00:00
    assert!(json.contains("Z") || json.contains("+00:00"),
        "Timestamp should be UTC: {}", json);
}

#[test]
fn test_cognitive_pulse_token_budget_approximately_30() {
    let pulse = CognitivePulse::new(
        0.3, 0.8, 0.5, 0.7,
        EmotionalState::Focused,
        SuggestedAction::Ready,
    );

    let json = serde_json::to_string(&pulse).unwrap();
    // Rough estimate: JSON characters / 4 ≈ tokens
    // Should be approximately 30 tokens (120-150 chars)
    let estimated_tokens = json.len() / 4;
    assert!(estimated_tokens < 60, "Pulse should be ~30 tokens, got ~{}: {}",
        estimated_tokens, json);
}
```

### Step 7: Fix Existing Tests That Use Old Signature

Update any tests using the old 3-parameter `new()` signature. Search for:
```rust
CognitivePulse::new(entropy, coherence, suggested_action)
```

Replace with:
```rust
CognitivePulse::new(
    entropy, coherence,
    0.5, 0.5,  // curiosity_score, confidence defaults
    EmotionalState::default(),
    suggested_action,
)
```

Or use `CognitivePulse::computed(entropy, coherence)` for auto-action calculation.

---

## Files to Modify

| File | Action | Lines |
|------|--------|-------|
| `crates/context-graph-core/src/types/pulse.rs` | ADD imports, MODIFY struct, UPDATE methods, ADD tests | ~50-100 lines changed |
| `crates/context-graph-core/src/stubs/layers.rs` | UPDATE `CognitivePulse::new()` calls to new signature | ~6 call sites |
| `crates/context-graph-core/tests/edge_case_tests.rs` | UPDATE test to use 7-field struct if needed | ~1-2 call sites |

---

## Verification Commands

```bash
# 1. Build check
cargo build --package context-graph-core

# 2. Run ALL pulse tests (should be 20+ tests)
cargo test --package context-graph-core pulse -- --nocapture

# 3. Run specific 7-field tests
cargo test --package context-graph-core cognitive_pulse_has_7 -- --nocapture

# 4. Clippy check (0 warnings required)
cargo clippy --package context-graph-core -- -D warnings

# 5. Format check
cargo fmt --package context-graph-core --check
```

---

## Full State Verification Protocol

### 1. Source of Truth
The source of truth is:
- **Struct definition**: `crates/context-graph-core/src/types/pulse.rs`
- **Compiled output**: Successful `cargo build`
- **Test results**: `cargo test` output

### 2. Execute & Inspect

After implementation, run:
```bash
# Prove struct compiles with 7 fields
cargo build --package context-graph-core 2>&1 | grep -E "(error|warning|Compiling)"

# Prove all tests pass
cargo test --package context-graph-core pulse -- --nocapture 2>&1 | tail -20

# Count test results
cargo test --package context-graph-core pulse 2>&1 | grep -E "^test result"
```

### 3. Boundary & Edge Case Audit

**You MUST test these 3 edge cases with before/after logging:**

**Edge Case 1: All Metrics at Boundaries**
```rust
// STATE BEFORE: Create pulse with out-of-range values
let pulse = CognitivePulse::new(
    2.0, -1.0, 999.0, -999.0,  // All out of [0,1]
    EmotionalState::Stressed,
    SuggestedAction::Stabilize,
);

// STATE AFTER: All should be clamped to [0,1]
println!("Edge Case 1 - Out of range clamping:");
println!("  entropy: {} (input: 2.0, expected: 1.0)", pulse.entropy);
println!("  coherence: {} (input: -1.0, expected: 0.0)", pulse.coherence);
println!("  curiosity_score: {} (input: 999.0, expected: 1.0)", pulse.curiosity_score);
println!("  confidence: {} (input: -999.0, expected: 0.0)", pulse.confidence);

assert_eq!(pulse.entropy, 1.0);
assert_eq!(pulse.coherence, 0.0);
assert_eq!(pulse.curiosity_score, 1.0);
assert_eq!(pulse.confidence, 0.0);
println!("Edge Case 1: PASS");
```

**Edge Case 2: Serde Roundtrip with All EmotionalState Variants**
```rust
for state in [
    EmotionalState::Neutral, EmotionalState::Curious,
    EmotionalState::Focused, EmotionalState::Stressed,
    EmotionalState::Fatigued, EmotionalState::Engaged,
    EmotionalState::Confused,
] {
    let pulse = CognitivePulse::new(0.5, 0.5, 0.5, 0.5, state, SuggestedAction::Continue);
    let json = serde_json::to_string(&pulse).unwrap();
    let parsed: CognitivePulse = serde_json::from_str(&json).unwrap();

    println!("Edge Case 2 - EmotionalState {:?}:", state);
    println!("  JSON: {}", json);
    println!("  Roundtrip emotional_state: {:?}", parsed.emotional_state);

    assert_eq!(pulse.emotional_state, parsed.emotional_state);
}
println!("Edge Case 2: PASS (all 7 EmotionalState variants roundtrip)");
```

**Edge Case 3: Timestamp Consistency**
```rust
let pulse1 = CognitivePulse::default();
std::thread::sleep(std::time::Duration::from_millis(10));
let pulse2 = CognitivePulse::default();

println!("Edge Case 3 - Timestamp uniqueness:");
println!("  pulse1.timestamp: {}", pulse1.timestamp);
println!("  pulse2.timestamp: {}", pulse2.timestamp);

assert!(pulse2.timestamp > pulse1.timestamp,
    "Later pulse should have later timestamp");
println!("Edge Case 3: PASS");
```

### 4. Evidence of Success

After ALL tests pass, create this verification log:

```
=== TASK-M02-021 Verification Report ===
Date: [YYYY-MM-DD HH:MM:SS UTC]
Commit: [git hash from `git rev-parse HEAD`]

1. BUILD: cargo build --package context-graph-core
   Result: [SUCCESS/FAIL]

2. TESTS: cargo test --package context-graph-core pulse
   Result: [X passed, Y failed]

3. CLIPPY: cargo clippy --package context-graph-core -- -D warnings
   Result: [0 warnings / X warnings]

4. STRUCT VERIFICATION:
   - CognitivePulse has 7 fields: [YES/NO]
   - Field entropy exists: [YES/NO]
   - Field coherence exists: [YES/NO]
   - Field curiosity_score exists: [YES/NO]
   - Field confidence exists: [YES/NO]
   - Field emotional_state exists: [YES/NO]
   - Field suggested_action exists: [YES/NO]
   - Field timestamp exists: [YES/NO]

5. EDGE CASES:
   - Boundary clamping: [PASS/FAIL]
   - EmotionalState serde: [PASS/FAIL]
   - Timestamp uniqueness: [PASS/FAIL]

6. MANUAL JSON OUTPUT INSPECTION:
   [Paste actual JSON output from one pulse serialization]

=== TASK-M02-021 [COMPLETE/INCOMPLETE] ===
```

---

## Final Verification: Sherlock-Holmes Agent

**MANDATORY**: After completing all implementation and tests, spawn the `sherlock-holmes` subagent:

```
Task(
  "Forensic verification of TASK-M02-021 CognitivePulse",
  "INVESTIGATE crates/context-graph-core/src/types/pulse.rs

   VERIFY THESE FACTS:
   1. CognitivePulse struct has EXACTLY 7 fields (not 3!)
   2. Fields are: entropy, coherence, curiosity_score, confidence, emotional_state, suggested_action, timestamp
   3. All f32 fields are clamped to [0,1] in new()
   4. timestamp uses chrono::DateTime<Utc>
   5. EmotionalState import from super::utl::EmotionalState
   6. Serde derives are present: Serialize, Deserialize
   7. All tests pass: cargo test --package context-graph-core pulse
   8. No clippy warnings: cargo clippy --package context-graph-core -- -D warnings

   PROVE WITH EVIDENCE:
   - Show the actual struct definition from file
   - Show test output
   - Show clippy output

   This code is GUILTY UNTIL PROVEN INNOCENT.",
  "sherlock-holmes"
)
```

If Sherlock identifies ANY issues, fix them before marking complete.

---

## NOT In Scope (Explicitly Excluded)

| Item | Why Excluded | Where Covered |
|------|--------------|---------------|
| `CognitivePulse::update()` | Business logic method | TASK-M02-022 |
| `CognitivePulse::blend()` | Business logic method | TASK-M02-022 |
| `CognitivePulse::to_json()` | Already have Serialize derive | N/A |
| EmotionalState implementation | Already complete | TASK-M02-019 ✅ |
| SuggestedAction implementation | Already complete | TASK-M02-020 ✅ |

---

## Anti-Patterns to AVOID (from constitution.yaml)

- **AP-001**: Do NOT use `unwrap()` in production code - use `expect()` with context
- **AP-009**: Do NOT allow NaN/Infinity in f32 fields - clamp to valid range
- **AP-007**: Do NOT use stub/mock data in tests - test real behavior
- **NO BACKWARDS COMPATIBILITY HACKS**: If something breaks, error fast with clear message

---

## Constitution Reference (pulse spec)

From `docs2/constitution.yaml` lines 298-299:
```yaml
mcp:
  pulse: { fields: [entropy, coherence, suggested_action], cost: "~30 tokens" }
```

Note: The constitution shows minimal fields, but TECH-CORE-002 Section 2.4 specifies the full 7-field struct for complete cognitive state.

---

*Task ID: TASK-M02-021*
*Module: 02 - Core Infrastructure*
*Layer: Surface*
*Last Updated: 2025-12-31*
*Audited Against: Commit 69ed2f6 (TASK-M02-019 complete)*
