# M05-T27: Integrate Real UTL Metrics into get_memetic_status MCP Tool

```yaml
metadata:
  id: "M05-T27"
  title: "Replace Hardcoded UTL Values with Live UtlProcessor Data"
  module: "module-05"
  module_name: "UTL Integration"
  layer: "integration"
  priority: "high"
  estimated_hours: 3
  created: "2026-01-04"
  updated: "2026-01-04"
  status: "pending"
  dependencies:
    - "M05-T22"  # UtlProcessor Orchestrator (COMPLETE)
    - "M05-T24"  # UtlMetrics and UtlStatus (COMPLETE)
  spec_refs:
    - "constitution.yaml:151-167"  # UTL formula and Johari definitions
    - "constitution.yaml:159-163"  # Johari quadrant → action mapping
```

## CRITICAL: Existing State (VERIFIED 2026-01-04)

### Current Implementation Returns HARDCODED STUB DATA

**File:** `crates/context-graph-mcp/src/handlers/tools.rs` lines 189-213

```rust
// CURRENT STUB - Returns hardcoded values, NOT live data
pub(super) async fn call_get_memetic_status(&self, id: Option<JsonRpcId>) -> JsonRpcResponse {
    let node_count = self.memory_store.count().await.unwrap_or(0);
    Self::tool_result(
        id,
        json!({
            "phase": "ghost-system",        // HARDCODED STRING
            "nodeCount": node_count,
            "utl": {
                "entropy": 0.5,             // HARDCODED - NOT FROM UtlProcessor
                "coherence": 0.8,           // HARDCODED - NOT FROM UtlProcessor
                "learningScore": 0.65,      // HARDCODED - NOT FROM UtlProcessor
                "suggestedAction": "continue"// HARDCODED - NOT FROM Johari
            },
            // ... layers stub ...
        }),
    )
}
```

### What Already Exists (DO NOT RECREATE)

| Component | File:Lines | Status |
|-----------|-----------|--------|
| `get_memetic_status` tool definition | `crates/context-graph-mcp/src/tools.rs:113-122` | EXISTS |
| `call_get_memetic_status` handler | `crates/context-graph-mcp/src/handlers/tools.rs:189-213` | EXISTS (STUB) |
| `UtlProcessor` trait | `crates/context-graph-core/src/traits/utl_processor.rs:1-52` | EXISTS |
| `StubUtlProcessor` impl | `crates/context-graph-core/src/stubs/utl_stub.rs:1-150` | EXISTS |
| `Handlers.utl_processor` field | `crates/context-graph-mcp/src/handlers/core.rs:14` | EXISTS |
| `UtlStatus` struct | `crates/context-graph-utl/src/metrics.rs:417-516` | EXISTS |

### The Single Objective

**Replace hardcoded values in `call_get_memetic_status` with `self.utl_processor.get_status()` data.**

There is NO need to:
- Create new files
- Create new structs
- Create new traits
- Modify Cargo.toml
- Create separate test files

## Implementation: Exact Code Change

### File: `crates/context-graph-mcp/src/handlers/tools.rs`

**REPLACE** lines 189-213 with:

```rust
/// get_memetic_status tool implementation.
///
/// Returns comprehensive system status including:
/// - Node count from memory store
/// - Live UTL metrics from UtlProcessor (NOT hardcoded)
/// - 5-layer bio-nervous system status
///
/// # Constitution References
/// - UTL formula: constitution.yaml:152
/// - Johari quadrant actions: constitution.yaml:159-163
pub(super) async fn call_get_memetic_status(&self, id: Option<JsonRpcId>) -> JsonRpcResponse {
    let node_count = self.memory_store.count().await.unwrap_or(0);

    // Get LIVE UTL status from the processor
    let utl_status = self.utl_processor.get_status();

    // Extract values with explicit defaults on parse failure
    let lifecycle_phase = utl_status
        .get("lifecycle_phase")
        .and_then(|v| v.as_str())
        .unwrap_or("Infancy");

    let entropy = utl_status
        .get("entropy")
        .and_then(|v| v.as_f64())
        .map(|v| v as f32)
        .unwrap_or(0.0);

    let coherence = utl_status
        .get("coherence")
        .and_then(|v| v.as_f64())
        .map(|v| v as f32)
        .unwrap_or(0.0);

    let learning_score = utl_status
        .get("learning_score")
        .and_then(|v| v.as_f64())
        .map(|v| v as f32)
        .unwrap_or(0.0);

    let johari_quadrant = utl_status
        .get("johari_quadrant")
        .and_then(|v| v.as_str())
        .unwrap_or("Hidden");

    let consolidation_phase = utl_status
        .get("consolidation_phase")
        .and_then(|v| v.as_str())
        .unwrap_or("Wake");

    // Map Johari quadrant to suggested action per constitution.yaml:159-163
    let suggested_action = match johari_quadrant {
        "Open" => "direct_recall",
        "Blind" => "trigger_dream",
        "Hidden" => "get_neighborhood",
        "Unknown" => "epistemic_action",
        _ => "continue",
    };

    Self::tool_result(
        id,
        json!({
            "phase": lifecycle_phase,
            "nodeCount": node_count,
            "utl": {
                "entropy": entropy,
                "coherence": coherence,
                "learningScore": learning_score,
                "johariQuadrant": johari_quadrant,
                "consolidationPhase": consolidation_phase,
                "suggestedAction": suggested_action
            },
            "layers": {
                "perception": "active",
                "memory": "active",
                "reasoning": "stub",
                "action": "stub",
                "meta": "stub"
            }
        }),
    )
}
```

### File: `crates/context-graph-mcp/src/tools.rs`

**REPLACE** lines 113-122 (tool description update):

```rust
// get_memetic_status - get UTL metrics and system state
ToolDefinition::new(
    "get_memetic_status",
    "Get current system status with LIVE UTL metrics from the UtlProcessor: \
     entropy (novelty), coherence (understanding), learning score (magnitude), \
     Johari quadrant classification, consolidation phase, and suggested action. \
     Also returns node count and 5-layer bio-nervous system status.",
    json!({
        "type": "object",
        "properties": {},
        "required": []
    }),
),
```

## Tests: Add to Existing Test File

### File: `crates/context-graph-mcp/src/handlers/tests/tools_call.rs`

**IMPORTANT:** This file already exists and has a `test_tools_call_get_memetic_status` test at lines 109-148.
That existing test only checks basic structure. **ADD** these NEW tests after line 148 (after the existing test):

```rust
// =============================================================================
// get_memetic_status Tests (M05-T27)
// =============================================================================

#[tokio::test]
async fn test_get_memetic_status_utl_values_in_valid_range() {
    let handlers = create_test_handlers();
    let request = make_request(
        "tools/call",
        Some(JsonRpcId::Number(1)),
        Some(json!({
            "name": "get_memetic_status",
            "arguments": {}
        })),
    );

    let response = handlers.dispatch(request).await;
    assert!(response.error.is_none(), "get_memetic_status should not error");

    let result = response.result.expect("Must have result");
    let content = result.get("content").expect("Must have content array");
    let text = content[0].get("text").expect("First content must have text");
    let data: serde_json::Value = serde_json::from_str(text.as_str().unwrap())
        .expect("text must be valid JSON");

    let utl = data.get("utl").expect("Response must have utl field");

    // Verify ranges per constitution.yaml:154-157
    let entropy = utl["entropy"].as_f64().expect("entropy must be f64");
    let coherence = utl["coherence"].as_f64().expect("coherence must be f64");
    let learning_score = utl["learningScore"].as_f64().expect("learningScore must be f64");

    assert!(
        entropy >= 0.0 && entropy <= 1.0,
        "entropy {} not in [0,1]", entropy
    );
    assert!(
        coherence >= 0.0 && coherence <= 1.0,
        "coherence {} not in [0,1]", coherence
    );
    assert!(
        learning_score >= 0.0 && learning_score <= 1.0,
        "learningScore {} not in [0,1]", learning_score
    );
}

#[tokio::test]
async fn test_get_memetic_status_johari_quadrant_valid() {
    let handlers = create_test_handlers();
    let request = make_request(
        "tools/call",
        Some(JsonRpcId::Number(1)),
        Some(json!({
            "name": "get_memetic_status",
            "arguments": {}
        })),
    );

    let response = handlers.dispatch(request).await;
    let result = response.result.expect("Must have result");
    let content = result.get("content").expect("Must have content");
    let text = content[0].get("text").expect("Must have text");
    let data: serde_json::Value = serde_json::from_str(text.as_str().unwrap()).unwrap();

    let utl = data.get("utl").expect("Must have utl");
    let johari = utl["johariQuadrant"].as_str().expect("johariQuadrant must be string");

    // Per constitution.yaml:159-163
    let valid_quadrants = ["Open", "Blind", "Hidden", "Unknown"];
    assert!(
        valid_quadrants.contains(&johari),
        "Invalid Johari quadrant: '{}'. Must be one of {:?}",
        johari, valid_quadrants
    );
}

#[tokio::test]
async fn test_get_memetic_status_suggested_action_matches_johari() {
    let handlers = create_test_handlers();
    let request = make_request(
        "tools/call",
        Some(JsonRpcId::Number(1)),
        Some(json!({
            "name": "get_memetic_status",
            "arguments": {}
        })),
    );

    let response = handlers.dispatch(request).await;
    let result = response.result.expect("Must have result");
    let content = result.get("content").expect("Must have content");
    let text = content[0].get("text").expect("Must have text");
    let data: serde_json::Value = serde_json::from_str(text.as_str().unwrap()).unwrap();

    let utl = data.get("utl").expect("Must have utl");
    let johari = utl["johariQuadrant"].as_str().unwrap();
    let action = utl["suggestedAction"].as_str().expect("suggestedAction must be string");

    // Verify mapping per constitution.yaml:159-163
    let expected_action = match johari {
        "Open" => "direct_recall",
        "Blind" => "trigger_dream",
        "Hidden" => "get_neighborhood",
        "Unknown" => "epistemic_action",
        _ => "continue",
    };

    assert_eq!(
        action, expected_action,
        "Johari '{}' should map to '{}', got '{}'",
        johari, expected_action, action
    );
}

#[tokio::test]
async fn test_get_memetic_status_not_hardcoded() {
    // The old stub returned: entropy=0.5, coherence=0.8, learningScore=0.65
    // StubUtlProcessor returns: entropy=0.0, coherence=0.0, learning_score=0.0
    // This test verifies we're NOT returning the old hardcoded values

    let handlers = create_test_handlers();
    let request = make_request(
        "tools/call",
        Some(JsonRpcId::Number(1)),
        Some(json!({
            "name": "get_memetic_status",
            "arguments": {}
        })),
    );

    let response = handlers.dispatch(request).await;
    let result = response.result.expect("Must have result");
    let content = result.get("content").expect("Must have content");
    let text = content[0].get("text").expect("Must have text");
    let data: serde_json::Value = serde_json::from_str(text.as_str().unwrap()).unwrap();

    let utl = data.get("utl").expect("Must have utl");

    // If these exact values appear, we're still using hardcoded stubs
    let entropy = utl["entropy"].as_f64().unwrap();
    let coherence = utl["coherence"].as_f64().unwrap();
    let learning_score = utl["learningScore"].as_f64().unwrap();

    // StubUtlProcessor returns all zeros initially
    // The OLD hardcoded stub returned 0.5, 0.8, 0.65
    let is_old_hardcoded = (entropy - 0.5).abs() < 0.001
        && (coherence - 0.8).abs() < 0.001
        && (learning_score - 0.65).abs() < 0.001;

    assert!(
        !is_old_hardcoded,
        "Values appear to be old hardcoded stub (0.5, 0.8, 0.65). \
         Implementation should use self.utl_processor.get_status()"
    );
}

#[tokio::test]
async fn test_get_memetic_status_consolidation_phase_valid() {
    let handlers = create_test_handlers();
    let request = make_request(
        "tools/call",
        Some(JsonRpcId::Number(1)),
        Some(json!({
            "name": "get_memetic_status",
            "arguments": {}
        })),
    );

    let response = handlers.dispatch(request).await;
    let result = response.result.expect("Must have result");
    let content = result.get("content").expect("Must have content");
    let text = content[0].get("text").expect("Must have text");
    let data: serde_json::Value = serde_json::from_str(text.as_str().unwrap()).unwrap();

    let utl = data.get("utl").expect("Must have utl");
    let phase = utl["consolidationPhase"].as_str().expect("consolidationPhase must be string");

    // Per constitution.yaml:211-213 (dream phases)
    let valid_phases = ["NREM", "REM", "Wake"];
    assert!(
        valid_phases.contains(&phase),
        "Invalid consolidation phase: '{}'. Must be one of {:?}",
        phase, valid_phases
    );
}
```

## Acceptance Criteria (Checkboxes)

- [ ] `call_get_memetic_status` calls `self.utl_processor.get_status()` instead of returning hardcoded values
- [ ] Response `entropy` is in [0.0, 1.0]
- [ ] Response `coherence` is in [0.0, 1.0]
- [ ] Response `learningScore` is in [0.0, 1.0]
- [ ] Response `johariQuadrant` is one of: Open, Blind, Hidden, Unknown
- [ ] Response `suggestedAction` correctly maps from Johari quadrant per constitution.yaml:159-163
- [ ] Response `consolidationPhase` is one of: NREM, REM, Wake
- [ ] All new tests pass
- [ ] No existing tests broken
- [ ] NO hardcoded 0.5, 0.8, 0.65 values remain

## Verification Protocol

### Source of Truth

The source of truth for UTL data is `self.utl_processor.get_status()` which returns `serde_json::Value`.

For `StubUtlProcessor` (current implementation):
- **File:** `crates/context-graph-core/src/stubs/utl_stub.rs:104-122`
- Returns: `{"lifecycle_phase":"Infancy","entropy":0.0,"coherence":0.0,"learning_score":0.0,"johari_quadrant":"Hidden","consolidation_phase":"Wake"}`

### Pre-Implementation Commands

```bash
# Verify current state - should show hardcoded values (0.5, 0.8, 0.65)
cargo build -p context-graph-mcp && \
echo '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_memetic_status","arguments":{}},"id":1}' | \
cargo run -p context-graph-mcp 2>/dev/null | jq -r '.result.content[0].text' | jq '.utl'

# Expected PRE-implementation output:
# {
#   "entropy": 0.5,          <-- HARDCODED (BAD)
#   "coherence": 0.8,        <-- HARDCODED (BAD)
#   "learningScore": 0.65,   <-- HARDCODED (BAD)
#   "suggestedAction": "continue"
# }
```

### Post-Implementation Commands

```bash
# Run all MCP tests (must all pass)
cargo test -p context-graph-mcp 2>&1 | tee /tmp/mcp-test.log
grep -E "test result|passed|failed" /tmp/mcp-test.log

# Run specific new tests
cargo test -p context-graph-mcp get_memetic_status

# Verify live data - should show StubUtlProcessor values
cargo build -p context-graph-mcp && \
echo '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_memetic_status","arguments":{}},"id":1}' | \
cargo run -p context-graph-mcp 2>/dev/null | jq -r '.result.content[0].text' | jq '.utl'

# Expected POST-implementation output:
# {
#   "entropy": 0.0,                    <-- FROM UtlProcessor (GOOD)
#   "coherence": 0.0,                  <-- FROM UtlProcessor (GOOD)
#   "learningScore": 0.0,              <-- FROM UtlProcessor (GOOD)
#   "johariQuadrant": "Hidden",        <-- NEW FIELD
#   "consolidationPhase": "Wake",      <-- NEW FIELD
#   "suggestedAction": "get_neighborhood"  <-- DERIVED FROM Johari
# }
```

## Edge Case Tests (Manual Verification Required)

### Edge Case 1: Empty Initial State
**Input:** Fresh handlers with no interactions
**Expected:** Valid default values from StubUtlProcessor
**Verify:** Call tool, check response has valid JSON structure

### Edge Case 2: Missing UtlProcessor Fields
**Input:** If `get_status()` returns incomplete JSON
**Expected:** Handler uses defaults, does NOT panic
**Verify:** The `.unwrap_or()` chains handle missing fields

### Edge Case 3: Invalid Johari Quadrant String
**Input:** If `get_status()` returns unknown quadrant like "InvalidQuadrant"
**Expected:** `suggested_action` falls back to "continue"
**Verify:** The `_ => "continue"` match arm handles this

## Evidence of Success Log

After implementation, paste output of:

```bash
echo "=== Test Results ===" && \
cargo test -p context-graph-mcp 2>&1 | grep -E "test.*ok|test.*FAILED|passed|failed" && \
echo "" && \
echo "=== Live Tool Output ===" && \
echo '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"get_memetic_status","arguments":{}},"id":1}' | \
cargo run -p context-graph-mcp 2>/dev/null | jq -r '.result.content[0].text' | jq '.'
```

## NO Backwards Compatibility

**CRITICAL:** This intentionally breaks old behavior. The old stub values were placeholders.

| Field | Old (STUB) | New (LIVE) |
|-------|------------|------------|
| `phase` | "ghost-system" | From `lifecycle_phase` |
| `utl.entropy` | 0.5 | From UtlProcessor |
| `utl.coherence` | 0.8 | From UtlProcessor |
| `utl.learningScore` | 0.65 | From UtlProcessor |
| `utl.suggestedAction` | "continue" | Derived from Johari |
| `utl.johariQuadrant` | (missing) | **NEW** |
| `utl.consolidationPhase` | (missing) | **NEW** |

## Files Modified (Summary)

| File | Lines | Change |
|------|-------|--------|
| `crates/context-graph-mcp/src/handlers/tools.rs` | 189-213 | REPLACE entire `call_get_memetic_status` function |
| `crates/context-graph-mcp/src/tools.rs` | 113-122 | UPDATE tool description string |
| `crates/context-graph-mcp/src/handlers/tests/tools_call.rs` | After line 148 | ADD 5 new tests to existing "get_memetic_status Tool Tests" section |

## Final Verification: Sherlock-Holmes Agent

After completing ALL implementation steps, invoke the `sherlock-holmes` subagent with this prompt:

```
FORENSIC VERIFICATION for M05-T27:

1. Read crates/context-graph-mcp/src/handlers/tools.rs
2. Verify call_get_memetic_status does NOT contain hardcoded values 0.5, 0.8, 0.65
3. Verify it calls self.utl_processor.get_status()
4. Verify Johari-to-action mapping matches constitution.yaml:159-163:
   - Open → direct_recall
   - Blind → trigger_dream
   - Hidden → get_neighborhood
   - Unknown → epistemic_action
5. Run: cargo test -p context-graph-mcp
6. Verify all tests pass with REAL assertions (not mock pass-throughs)
7. Call get_memetic_status tool and verify response contains johariQuadrant and consolidationPhase fields
8. Confirm response values come from UtlProcessor, not hardcoded strings
```

The task is ONLY complete when sherlock-holmes confirms all 8 verification points pass.
