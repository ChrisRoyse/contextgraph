# M05-T26: Implement utl_status MCP Tool

```yaml
metadata:
  id: "M05-T26"
  title: "Implement utl_status MCP Tool"
  module: "module-05"
  module_name: "UTL Integration"
  layer: "integration"
  priority: "critical"
  estimated_hours: 3
  created: "2026-01-04"
  status: "pending"
  dependencies:
    - "M05-T22"
    - "M05-T24"
  spec_refs:
    - "SPEC-UTL-005 Section 10.1"
```

## Description

Implement the utl_status MCP tool handler for querying UTL state.
- UtlStatusRequest: session_id (Option<Uuid>)
- UtlStatusResponse: lifecycle_phase, interaction_count, entropy, coherence, learning_score, johari_quadrant, consolidation_phase, phase_angle, emotional_state (EmotionalStateResponse), thresholds (ThresholdsResponse), suggested_action
- Add handler to MCP server tool registry
- Include session-scoped and global status modes

## File Locations

| Type | Path |
|------|------|
| Implementation | `crates/context-graph-mcp/src/tools/utl_status.rs` |
| Test File | `crates/context-graph-mcp/tests/utl_status_tests.rs` |

## Acceptance Criteria

- [ ] utl_status tool registered in MCP server
- [ ] Returns complete UtlStatusResponse with all fields
- [ ] Session-scoped queries work correctly
- [ ] Global queries aggregate across sessions
- [ ] Response matches SPEC-UTL-005 Section 10.1 schema

## Technical Requirements

### Request/Response Schema

```rust
// crates/context-graph-mcp/src/tools/utl_status.rs

use serde::{Deserialize, Serialize};
use uuid::Uuid;
use context_graph_utl::{
    LifecycleStage, JohariQuadrant, SuggestedAction,
    ConsolidationPhase, EmotionalState, UtlStatus,
};

/// Request schema for utl_status MCP tool
#[derive(Debug, Clone, Deserialize)]
pub struct UtlStatusRequest {
    /// Optional session ID for session-scoped query.
    /// If None, returns global/aggregate UTL status.
    pub session_id: Option<Uuid>,
}

/// Emotional state response for MCP serialization
#[derive(Debug, Clone, Serialize)]
pub struct EmotionalStateResponse {
    /// Valence: positive (+1) to negative (-1)
    pub valence: f32,
    /// Arousal: calm (0) to excited (1)
    pub arousal: f32,
    /// Computed emotional weight in [0.5, 1.5]
    pub weight: f32,
}

impl From<EmotionalState> for EmotionalStateResponse {
    fn from(state: EmotionalState) -> Self {
        Self {
            valence: state.valence,
            arousal: state.arousal,
            weight: state.compute_weight(),
        }
    }
}

/// Thresholds response containing current stage-specific thresholds
#[derive(Debug, Clone, Serialize)]
pub struct ThresholdsResponse {
    /// Entropy threshold for triggering exploration
    pub entropy_trigger: f32,
    /// Coherence threshold for stability
    pub coherence_trigger: f32,
    /// Minimum importance for storage
    pub min_importance_store: f32,
    /// Consolidation threshold
    pub consolidation_threshold: f32,
}

/// Complete UTL status response
#[derive(Debug, Clone, Serialize)]
pub struct UtlStatusResponse {
    /// Current lifecycle phase (Infancy, Growth, Maturity)
    pub lifecycle_phase: String,

    /// Total interaction count
    pub interaction_count: u64,

    /// Current entropy (delta_s) in [0, 1]
    pub entropy: f32,

    /// Current coherence (delta_c) in [0, 1]
    pub coherence: f32,

    /// Learning score/magnitude in [0, 1]
    pub learning_score: f32,

    /// Current Johari quadrant classification
    pub johari_quadrant: String,

    /// Consolidation phase (Encoding, Transition, Consolidation)
    pub consolidation_phase: String,

    /// Phase oscillator angle phi in [0, PI]
    pub phase_angle: f32,

    /// Current emotional state
    pub emotional_state: EmotionalStateResponse,

    /// Current stage-specific thresholds
    pub thresholds: ThresholdsResponse,

    /// Suggested action based on quadrant
    pub suggested_action: String,

    /// Marblestone lambda weights
    pub lambda_weights: LambdaWeightsResponse,
}

#[derive(Debug, Clone, Serialize)]
pub struct LambdaWeightsResponse {
    pub lambda_novelty: f32,
    pub lambda_consolidation: f32,
}

impl From<UtlStatus> for UtlStatusResponse {
    fn from(status: UtlStatus) -> Self {
        Self {
            lifecycle_phase: status.lifecycle_stage.name().to_string(),
            interaction_count: status.interaction_count,
            entropy: status.current_entropy,
            coherence: status.current_coherence,
            learning_score: status.learning_magnitude,
            johari_quadrant: status.quadrant.name().to_string(),
            consolidation_phase: status.consolidation_phase.name().to_string(),
            phase_angle: status.phase_angle,
            emotional_state: status.emotional_state.into(),
            thresholds: ThresholdsResponse {
                entropy_trigger: status.thresholds.entropy_trigger,
                coherence_trigger: status.thresholds.coherence_trigger,
                min_importance_store: status.thresholds.min_importance_store,
                consolidation_threshold: status.thresholds.consolidation_threshold,
            },
            suggested_action: status.suggested_action.name().to_string(),
            lambda_weights: LambdaWeightsResponse {
                lambda_novelty: status.lambda_weights.lambda_novelty,
                lambda_consolidation: status.lambda_weights.lambda_consolidation,
            },
        }
    }
}
```

### Tool Handler Implementation

```rust
use async_trait::async_trait;
use crate::tools::{McpTool, McpToolContext, McpToolResult};

pub struct UtlStatusTool;

#[async_trait]
impl McpTool for UtlStatusTool {
    fn name(&self) -> &'static str {
        "utl_status"
    }

    fn description(&self) -> &'static str {
        "Query current UTL (Unified Theory of Learning) state including lifecycle phase, \
         entropy, coherence, learning score, and Johari quadrant classification."
    }

    fn input_schema(&self) -> serde_json::Value {
        serde_json::json!({
            "type": "object",
            "properties": {
                "session_id": {
                    "type": "string",
                    "format": "uuid",
                    "description": "Optional session ID for session-scoped query"
                }
            },
            "required": []
        })
    }

    async fn execute(
        &self,
        input: serde_json::Value,
        context: &McpToolContext,
    ) -> McpToolResult<serde_json::Value> {
        let request: UtlStatusRequest = serde_json::from_value(input)
            .map_err(|e| McpToolError::InvalidInput(e.to_string()))?;

        let utl_processor = context.get_utl_processor()?;

        let status = match request.session_id {
            Some(session_id) => {
                // Session-scoped query
                utl_processor.get_session_status(session_id)?
            }
            None => {
                // Global/aggregate query
                utl_processor.get_status()
            }
        };

        let response = UtlStatusResponse::from(status);

        Ok(serde_json::to_value(response)?)
    }
}
```

### MCP Server Registration

```rust
// In crates/context-graph-mcp/src/server.rs

use crate::tools::utl_status::UtlStatusTool;

impl McpServer {
    pub fn register_utl_tools(&mut self) {
        self.register_tool(Box::new(UtlStatusTool));
    }
}
```

### JSON Schema (MCP Protocol)

```json
{
  "name": "utl_status",
  "description": "Query current UTL (Unified Theory of Learning) state including lifecycle phase, entropy, coherence, learning score, and Johari quadrant classification.",
  "inputSchema": {
    "type": "object",
    "properties": {
      "session_id": {
        "type": "string",
        "format": "uuid",
        "description": "Optional session ID for session-scoped query. If omitted, returns global status."
      }
    },
    "required": []
  }
}
```

### Example Response

```json
{
  "lifecycle_phase": "Growth",
  "interaction_count": 127,
  "entropy": 0.62,
  "coherence": 0.74,
  "learning_score": 0.58,
  "johari_quadrant": "Open",
  "consolidation_phase": "Encoding",
  "phase_angle": 0.45,
  "emotional_state": {
    "valence": 0.3,
    "arousal": 0.5,
    "weight": 1.15
  },
  "thresholds": {
    "entropy_trigger": 0.7,
    "coherence_trigger": 0.4,
    "min_importance_store": 0.3,
    "consolidation_threshold": 0.5
  },
  "suggested_action": "DirectRecall",
  "lambda_weights": {
    "lambda_novelty": 0.5,
    "lambda_consolidation": 0.5
  }
}
```

## Dependencies

### Required Tasks
- M05-T22: UtlProcessor Main Orchestrator
- M05-T24: UtlMetrics and UtlStatus Structs

### Required Crates
```toml
[dependencies]
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
async-trait = "0.1"
uuid = { version = "1.0", features = ["v4", "serde"] }
```

## Test Cases

```rust
// crates/context-graph-mcp/tests/utl_status_tests.rs

#[tokio::test]
async fn test_utl_status_global_query() {
    let server = create_test_mcp_server().await;

    let response = server.call_tool("utl_status", json!({})).await.unwrap();

    // Verify all required fields present
    assert!(response.get("lifecycle_phase").is_some());
    assert!(response.get("interaction_count").is_some());
    assert!(response.get("entropy").is_some());
    assert!(response.get("coherence").is_some());
    assert!(response.get("learning_score").is_some());
    assert!(response.get("johari_quadrant").is_some());
    assert!(response.get("consolidation_phase").is_some());
    assert!(response.get("phase_angle").is_some());
    assert!(response.get("emotional_state").is_some());
    assert!(response.get("thresholds").is_some());
    assert!(response.get("suggested_action").is_some());
}

#[tokio::test]
async fn test_utl_status_session_scoped() {
    let server = create_test_mcp_server().await;
    let session_id = Uuid::new_v4();

    // Store some context in the session first
    server.call_tool("store_memory", json!({
        "session_id": session_id.to_string(),
        "content": "Test memory content"
    })).await.unwrap();

    let response = server.call_tool("utl_status", json!({
        "session_id": session_id.to_string()
    })).await.unwrap();

    assert!(response.get("interaction_count").unwrap().as_u64().unwrap() >= 1);
}

#[tokio::test]
async fn test_utl_status_value_ranges() {
    let server = create_test_mcp_server().await;

    let response = server.call_tool("utl_status", json!({})).await.unwrap();

    let entropy = response["entropy"].as_f64().unwrap() as f32;
    let coherence = response["coherence"].as_f64().unwrap() as f32;
    let learning_score = response["learning_score"].as_f64().unwrap() as f32;
    let phase_angle = response["phase_angle"].as_f64().unwrap() as f32;
    let emotional_weight = response["emotional_state"]["weight"].as_f64().unwrap() as f32;

    assert!(entropy >= 0.0 && entropy <= 1.0);
    assert!(coherence >= 0.0 && coherence <= 1.0);
    assert!(learning_score >= 0.0 && learning_score <= 1.0);
    assert!(phase_angle >= 0.0 && phase_angle <= std::f32::consts::PI);
    assert!(emotional_weight >= 0.5 && emotional_weight <= 1.5);
}
```

## Verification

```bash
# Run tests
cargo test --package context-graph-mcp --test utl_status_tests

# Test MCP tool manually via JSON-RPC
echo '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"utl_status","arguments":{}},"id":1}' | cargo run --package context-graph-mcp
```

## Notes

- Session-scoped queries should return session-specific UTL state
- Global queries aggregate/average across all active sessions
- Response schema is forward-compatible for future field additions
- Tool registration happens during MCP server initialization
